# Use a Python base image suitable for handling external binaries (like those PyMuPDF might need)
# We use a slightly larger image because PyMuPDF has system dependencies.
FROM python:3.9-slim

# Install system dependencies needed by PyMuPDF (fitz)
# This is crucial for successful deployment of PyMuPDF.
RUN apt-get update && apt-get install -y \
    libjpeg-dev \
    zlib1g-dev \
    libfreetype6-dev \
    liblcms2-dev \
    libopenjp2-7 \
    libtiff5 \
    tk \
    && rm -rf /var/lib/apt/lists/*

# Set environment variables
ENV PYTHONUNBUFFERED True
WORKDIR /app

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code and templates
COPY . .

# Cloud Run uses the PORT environment variable
ENV PORT 8080

# Use Gunicorn to run the Flask application
# The workers count (1-4) should be adjusted based on memory usage.
# We set high memory in the deployment step because of pandas/sklearn.
CMD exec gunicorn --bind :$PORT --workers 2 --threads 4 app:app
